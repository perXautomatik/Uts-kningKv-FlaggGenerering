
--restored f06f0478.000
--;if object_id('tempdb..##FulaAdresser') is null begin CREATE table tempdb.dbo.##FulaAdresser (adress NVARCHAR NOT NULL PRIMARY KEY ) INSERT INTO tempdb.dbo.##FulaAdresser VALUES('DALHEM HALLVIDE 119, HALFVEDE, 62256 DALHEM'), ('c/o LILIAN PETTERSSON, SANDA STENHUSE 310'), ('DALHEM GRANSKOGS 966'), ('GRANSKOGS DALHEM 966'), (N'GAMLA NORRBYVÄGEN 15, ÖSTRA TÄCKERÅKER, 13674 NORRBY'), (N'ÖSTRA TÄCKERÅKER GAMLA NORRBYVÄGEN 15'), (N'ALVA GUDINGS 328 VÅN 2, GAMLA SKOLAN, 62346 HEMSE'), ('DALHEM KAUNGS 538, DUNBODI, 62256 DALHEM'), ('HERTZBERGSGATE 3 A0360 OSLO NORGE'), ('DALHEM HALLVIDE 119, HALFVEDE'), ('OLAV M. TROVIKS VEI 500864 OSLO NORGE'), ('LORNSENSTR. 30DE-24105 KIEL TYSKLAND'), (N'FRÜLINGSSTRASSE 3882110 GERMENING TYSKLAND'), (N'c/o FÖRENINGEN GOTLANDSTÅGET HÄSSELBY 166'), ('c/o TRYGGVE PETTERSSON KAUNGS 524'), (N'c/o L. ANDERSSON DJURSTRÖMS VÄG 11'), (N'PRÄSTBACKEN 8'), ('HALLA BROE 105'), (N'GAMLA SKOLAN ALVA GUDINGS 328 VÅN 2')
--end;

if object_id('tempdb..##kalla') is null begin
    BEGIN TRANSACTION;
    if object_id('tempdb..##fordig') is not null begin drop table tempdb.dbo.##FORDIG END;
with
    COLUMNPROCESSBADNESSSCORE AS (   SELECT FNR , org , ANDEL , namn , INSKDATUM , adress ,  POSTORT ,  POSTNR , 'geosecma' src
    , ((CASE WHEN namn IS NULL THEN 1 ELSE 0 END) + (CASE WHEN postnr IS NULL THEN 1 ELSE 0 END) + (CASE WHEN postort IS NULL THEN 1 ELSE 0 END)
	+ (CASE WHEN adress IS NULL THEN 1 ELSE 0 END) + (CASE WHEN org is NULL THEN 1 ELSE 0 END))    BADNESS
	FROM (SELECT namn, org, FNR, ANDEL, INSKDATUM, ADRESS
	    , nullif(CASE WHEN spaceLoc > 0 THEN substring(POSTNRPOSTORT, spaceLoc + 1, LEN(POSTNRPOSTORT)) END,'') POSTORT
	    , nullif(CASE WHEN spaceLoc > 0 THEN  left(POSTNRPOSTORT, spaceLoc - 1) END,'') POSTNR
	    FROM (select *,charindex(' ', POSTNRPOSTORT) spaceLoc from
		 (SELECT nullif(NAME,'') namn , nullif(PERSORGNR,'') org, FNR, ANDEL, INSKDATUM
		 , CASE WHEN CommaLoc > 0 AND POSTORT IS NULL AND POSTNR IS NULL THEN substring(ADRESS, CommaLoc + 2, LEN(ADRESS))Else concat(POSTNR,' ',POSTORT) END POSTNRPOSTORT
		 , nullif(CASE WHEN CommaLoc > 0 AND POSTORT IS NULL AND POSTNR IS NULL THEN left(ADRESS, CommaLoc - 1) else ADRESS END,'') ADRESS
		 FROM (select *,charindex(',', ADRESS) CommaLoc from (
		     SELECT NAME
			  , PERSONORGANISATIONNR PERSORGNR
			      , REALESTATEKEY        FNR
			      , SHAREPART            ANDEL
			      , ACQUISITIONDATE      INSKDATUM
			      , ADDRESS              ADRESS
			      , NULL                 POSTORT
			      , NULL                 POSTNR
			 FROM [gisdata].SDE_GEOFIR_GOTLAND.GNG.INFO_CURRENTOWNER q
			    INNER JOIN tempdb.dbo.##TOINSERT x on x.FNR = q.REALESTATEKEY
		     ) SRC) src)q) SPLITADRESS) ADRESSSPLITTER)
    , rest AS (SELECT Z.FNR, null ORG, 		null ANDEL,null NAMN,  null  co, null ADRESS, null  adr2, null POSTNR, null POSTORT, null SRC from COLUMNPROCESSBADNESSSCORE z WHERE BADNESS > 1)
     --, rest as (SELECT * from ip except (SELECT fnr from SRC1LAGFARa))
    , SRC1LAGFARa AS (SELECT Z.FNR, Z.ORG, 	Z.ANDEL,Z.NAMN,  '' co, Z.ADRESS, '' adr2, Z.POSTNR, Z.POSTORT, SRC FROM COLUMNPROCESSBADNESSSCORE z WHERE BADNESS < 2)

SELECT * into tempdb.dbo.##kalla from SRC1LAGFARa union all SELECT *from rest;
end